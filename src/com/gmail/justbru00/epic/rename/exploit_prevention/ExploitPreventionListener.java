package com.gmail.justbru00.epic.rename.exploit_prevention;

import java.util.Map.Entry;

import org.bukkit.Bukkit;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.HumanEntity;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryOpenEvent;
import org.bukkit.event.inventory.InventoryType;
import org.bukkit.inventory.ItemStack;

import com.gmail.justbru00.epic.rename.main.v3.Main;
import com.gmail.justbru00.epic.rename.utils.v3.Debug;
import com.gmail.justbru00.epic.rename.utils.v3.Messager;

public class ExploitPreventionListener implements Listener {

	@EventHandler(priority=EventPriority.HIGHEST)
	public void onInventoryOpenEvent(InventoryOpenEvent e) {		
		// 1.14 or higher versions with grindstone
		if (Bukkit.getVersion().contains("1.14")) {
			if (Main.getBooleanFromConfig("disable_grindstone_for_glowing_items")) {
				if (e.getInventory().getType() == InventoryType.GRINDSTONE) {
					Debug.send("[ExploitPreventionListener] Grindstone prevention is enabled and a grindstone inventory was opened.");
					
					final HumanEntity eventPlayer = e.getPlayer();
					
					// Check all inventory items
					// Grindstone
					for (ItemStack is : e.getInventory().getStorageContents()) {
						if (is == null) {
							continue;
						}						
						for (Entry<Enchantment,Integer> enchantment : is.getEnchantments().entrySet()) {							
							if (enchantment.getKey().equals(Enchantment.LURE) || enchantment.getKey().equals(Enchantment.ARROW_INFINITE)) {
								if (enchantment.getValue() == 4341) {
									// Is a glowing item
									Bukkit.getScheduler().scheduleSyncDelayedTask(Main.getInstance(), new Runnable() {										
										@Override
										public void run() {			
											Debug.send("[ExploitPreventionListener] Item has glowing! Closing Inventory.");
											eventPlayer.closeInventory();
											Messager.msgSenderWithConfigMsg("exploit_prevention.no_grindstone_with_glowing_items", eventPlayer);
											Messager.msgConsole("[ExploitPreventionListener] Player: " + eventPlayer.getName() + "'s inventory was closed because they tried to use a grindstone with a glowing item in their inventory. ");
										}
									}, 1);
								}
							}
						}
					}
					
					// Player Inventory
					for (ItemStack is : e.getPlayer().getInventory().getStorageContents()) {
						if (is == null) {
							continue;
						}	
						for (Entry<Enchantment,Integer> enchantment : is.getEnchantments().entrySet()) {
							if (enchantment.getKey().equals(Enchantment.LURE) || enchantment.getKey().equals(Enchantment.ARROW_INFINITE)) {
								if (enchantment.getValue() == 4341) {
									// Is a glowing item
									Bukkit.getScheduler().scheduleSyncDelayedTask(Main.getInstance(), new Runnable() {										
										@Override
										public void run() {		
											Debug.send("[ExploitPreventionListener] Item has glowing! Closing Inventory.");
											eventPlayer.closeInventory();
											Messager.msgSenderWithConfigMsg("exploit_prevention.no_grindstone_with_glowing_items", eventPlayer);
											Messager.msgConsole("[ExploitPreventionListener] Player: " + eventPlayer.getName() + "'s inventory was closed because they tried to use a grindstone with a glowing item in their inventory. ");
										}
									}, 1);
								}
							}
						}
					}
				}
			}			
		}	
	}
	
}
